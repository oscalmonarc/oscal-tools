<% # encoding: utf-8 %>
Trying to load rev 5
<% cache render_async_cache_key(request.path), :skip_digest => true do %>
	<%= button_to 'All Docs', docs_path, method: :get  %><br>
	<% require 'open-uri' 
	path = @doc.grab_file_path
	
	@doc.imported = Time.current
	@doc.save
	the_policy = @doc.security_policy
	version = the_policy.version
	policy_name = the_policy.name
	provider = Provider.find_or_create_by(name: "NIST")
 	@policy4 = nil
	@policy4 = SecurityPolicy.where(version: "4", name: "SP800-53", provider: provider).first
	@stored_refs = []
	@stored_related_controls = []
	
	def base_az(num)
		  # temp variable for converting base
		  temp = num
		
		  # the base 26 (az) number
		  az = ''
		
		  while temp > 0
		
		    # get the remainder and convert to a letter
		    num26 = temp % 26
		    temp /= 26
		
		    # offset for lack of "0"
		    temp -= 1 if num26 == 0
		
		    az = (num26).to_s(26).tr('0-9a-p', 'ZA-Y') + az
		  end
		
		  return az
	end
	
	def clean_up
		if (@stored_related_controls != nil) && (@stored_related_controls.count > 0)
			tmp_refs = @stored_related_controls
			@stored_related_controls = []
			
			tmp_refs.each do |ref|
				
				create_related_control(ref[:owner_object], ref[:related_control], ref[:the_policy], ref[:reason], ref[:type])
			end
		end
	end
	
	def letter_sequence(n)
	   return n.to_s(26).each_char.map {|i| ('A'..'Z').to_a[i.to_i(26)]}.join
	end
	
	def create_related(related, the_sc, the_policy, the_object)
		
		#Related Controls 
		object_id = the_object.id
		object_type = the_object.class
		object_type = object_type.to_s.downcase
		
		%> Checking create related --- <%= related %> <br><br.<%
		
		#related_controls = related.split(" <br>")
		checkParam(related, the_sc)
		related_controls = related.split(",")
		related_controls.each do |related_control|
			
			related_control = related_control.strip
			#related_control = related_control.gsub ".", ""
			#related_control = related_control.gsub "s:", ""
			#related_control = related_control.gsub ": ", ""
			#related_control = related_control.gsub " ", ""
			#related_control = related_control.gsub "s: ", ""
			%> going to create a related control for <%= related_control %> <br><br> <% 
			create_related_control(the_object, related_control, the_policy, "related", "guidance")
		end
		
	end
	
	def regex_is_number? string
	  no_commas =  string.gsub(',', '')
	  matches = no_commas.match(/-?\d+(?:\.\d+)?/)
	  if !matches.nil? && matches.size == 1 && matches[0] == no_commas
	    true
	  else
	    false
	  end
	end
	
	def create_relatedrefs(theSentance, security_control, requirement)
		theSentance = theSentance.gsub ";", ","
		theSentance = theSentance.gsub "800-61:", "800-61,"
		
		theSentance = theSentance.gsub "800- ", "800-"
		pattern = /(FIPS )([0-9]+\-[0-9]+)/
		theSentance = theSentance.gsub(pattern) {$1 + "Publication " + $2} 
		theSentance = theSentance.gsub "Memoranda", "Memorandum"
		theSentance = theSentance.gsub "FIPS Publications", "FIPS Publication"
		theSentance = theSentance.gsub "GUIDANCE/MEDIA_DESTRUCTION_GUIDANCE", "mitigation_guidance/media_destruction_guidance"
		theSentance = theSentance.gsub "DCID 6/9", "ICD 705"
		theSentance = theSentance.gsub "Web: ", "http://"
		theSentance = theSentance.gsub "C.F.R. Part 5 Subpart C (5 C.F.R 930.301)", "C.F.R. Part 5 Subpart C (5 C.F.R. 930.301)"
	
		tempRefs = theSentance.split " <br> "
		tempRefs.each do |thisRef|
			refs = thisRef.split ","
			refs.each do |ref|
				checkParam(ref, security_control)
				if !(ref.include? "References: None") 
				
					ref = ref.gsub "References: ", ""
					ref = ref.strip
					ref = ref.gsub(/ APPENDIX [A-Z-]+/,'')
					ref = ref.gsub "NIST Publication " ,''
					ref = ref.gsub(/\.$/, '')
					ref = ref.gsub "800-39. <br>", "800-39"
					
					ref = ref.gsub "http://TSP.NCS.GOV", "telecommunications-service-priority-tsp"
					ref = ref.gsub "HSPD 12","HSPD-12"
					ref = ref.gsub "CFR","C.F.R."
					
					the_ref = Ref.where(title: ref).first
					
					if (the_ref == nil)
						the_ref = Ref.where('title like ?', "%#{ref}").first	
						if (the_ref == nil)
							createRef = false
							
							if (ref == "OMB Memorandum 03-22")
								ref_url = "https://www.whitehouse.gov/wp-content/uploads/2017/11/203-M-03-22-OMB-Guidance-for-Implementing-the-Privacy-Provisions-of-the-E-Government-Act-of-2002-1.pdf"
								createRef = true
							elsif (ref == "5 CFR 731.106(a)")
								ref_url = "https://www.ecfr.gov/cgi-bin/text-idx?SID=3a6ca07029b27e80c1abcbadea908fc9&mc=true&node=pt5.2.731&rgn=div5#se5.2.731_1106"
								createRef = true
							elsif (ref == "http://CSRC.NIST.GOV/PCIG/CIG.HTML")  
								ref_url = "https://web.archive.provider/web/20040206102720/http://CSRC.NIST.GOV/PCIG/CIG.HTMl"
								createRef = true
							elsif (ref == "http://WWW.CIO.GOV/EAUTHENTICATION")
								ref_url = "https://web.archive.provider/web/20090321065815/http://WWW.CIO.GOV/EAUTHENTICATION"
								createRef = true
							elsif (ref == "http://WWW.FSAM.GOV")
								ref_url = "https://web.archive.provider/web/20120123090146/http://www.fsam.gov"
								createRef = true
							else(ref == "OMB Memorandum 02-01")
								ref_url = "https://web.archive.provider/web/20170108085255/https://www.whitehouse.gov/omb/memoranda_m02-01"
								createRef = true
							end
							
							if (createRef)
								last_ref = Ref.order("created_at").last
								if (last_ref != nil)
									the_last_ref_id = last_ref.ref_id
									last_ref_id = the_last_ref_id.gsub("ref","")
									last_ref_id = last_ref_id.to_i
									last_ref_id = last_ref_id + 1
									ref_id = "ref#{last_ref_id}"
								else
									ref_id = 100
								end	
								puts "ref - #{ref}"
									the_ref = Ref.find_or_create_by(ref_id: ref_id, title: ref, url: ref_url)
								
							end
						end
					end
					
					the_related_ref = RelatedRef.find_or_create_by(owner_object_type: "SecurityControl", owner_object_id: security_control.id, 
						object_id: the_ref.id, object_type: "Ref", title: the_ref.title, rel: "reference")
				end
			end
		end
	end
	
	def create_related_control(owner_object, related_control, the_policy, reason, type)
		
		if (type == "guidance")
			type = "Guidance"
		elsif (type == "securitycontrol")
			type = "SecurityControl"
		end
		
		
		#check if the last character is a string or int. if true its an int 
		if (related_control[-1].to_i.to_s == related_control[-1] )
			
			the_related_object = SecurityControl.where(control_id: related_control, security_policy_id: the_policy.id).first
			if (the_related_object != nil)
				title = the_related_object.control_id
			end
		else
			tmp_control_string = related_control[0...-1]
			statement_letter = "#{related_control[-1].strip}."
			
			
			tmp_control = SecurityControl.where(control_id: tmp_control_string, security_policy_id: the_policy.id).first
			if (tmp_control != nil)
				tmp_statements = Statement.where(security_control_id: tmp_control.id)
				if (tmp_statements  != nil)
					tmp_statements.each do |check_this|
						if check_this.description.starts_with? (statement_letter)
							%> Statement found - <%= check_this.description %> <br><%
							the_related_object = check_this
							type = "Sstatement"
							title = related_control
						else
							%> not found -<%= statement_letter %>-<%=check_this.description%><br><br><% 
						end
					end
					
				end
			else
				%> control not found <%= tmp_control_string %> <br><br><%
			end 
		end
		
		if (the_related_object == nil)
		  %> Storing for Related Control for it is <%= related_control %> <%
			tmp_ref = {owner_object: owner_object, related_control: related_control, the_policy: the_policy, reason: reason, type: type} 
			@stored_related_controls << tmp_ref  	
		else
			owner_object_type = owner_object.class.name
			the_related_object_type = the_related_object.class.name
			%> Related Control for it is <%= the_related_object.inspect %> - owner_object_type: <%= owner_object_type %> 
			the_related_object_type-<%= the_related_object_type%> <br<br><%
			
			
			the_related_ref = RelatedRef.find_or_create_by(owner_object_type: owner_object_type, owner_object_id: owner_object.id, 
			object_id: the_related_object.id, object_type: the_related_object_type, title: title, rel: reason)
			
			%> Created the_related_ref - <%= the_related_ref.inspect %> <br><br> <%
		end

	end
	
	def create_statement_items(items, parent_statement_id, parent_item_id, step, the_sc)
		parentItemLetter = nil
		the_letter = ""
		
		step = step + 1
		items.each do |the_item|
			the_children = the_item.split("<br>#{step}")
			
			the_item = the_children.first
			 
			the_item = the_item.strip
			if (the_item != "")
				if (the_sc.control_class == "SP800-53-enhancement")
					the_item = the_item.gsub "(i)", "a."
					the_item = the_item.gsub "(ii)", "b."
					the_item = the_item.gsub "(iii)", "c."
					the_item = the_item.gsub "(iv)", "d."
					the_item = the_item.gsub "(v)", "e."
				else
					the_item = the_item.gsub "(i)", "1."
					the_item = the_item.gsub "(ii)", "2."
					the_item = the_item.gsub "(iii)", "3."
					the_item = the_item.gsub "(iv)", "4."
					the_item = the_item.gsub "(v)", "5."
					the_item = the_item.gsub "(vi)", "6."
					
				end
		
				checkParam(the_item, the_sc)
				%>the_item - <%= the_item %> <br><%
				
				the_letter = the_item[0,1]
				
				abv = the_sc.control_id
				newabv = abv.gsub (/([A-Z]+)/) { |str| str.downcase }
				%>the_letter - <%= the_letter %> <br><%
				%>abv - <%= abv%> <br><%
				%>newabv - <%= newabv %> <br><%
			 	if (regex_is_number? the_letter)
			 		the_letter ="#{parentItemLetter}.#{the_letter}" 
				else
					parentItemLetter = the_letter
				end
				
				item_id = "#{newabv}_smt_#{the_letter}"
				item_name = "#{abv}#{the_letter}."
				
				pattern = /^([0-9]{1,2}.)|^([a-z].)/
				description = the_item.gsub (pattern), ""
				tmp_item = Item.find_or_create_by(item_id: item_id, name: item_name, description: description, statement_id: parent_statement_id)
				parentItem = tmp_item
				parent_item = true
				if (the_children.count >1)
					create_statement_items(the_children, parent_statement_id, tmp_item, step, the_sc)
				end
			end
			
		end
	end
	
	def checkParam(theSentance, the_sc)
		if (theSentance.include?("[Param:"))
			theSentance = theSentance.split("[Param:")
			counter = 0
			paramsize = theSentance.size
			if (theSentance[1] != nil)
				theSentance.each do |param|
					if (counter > 0)
						param = theSentance[counter]
						param = param.gsub (/].+/), ""
						the_param = Param.find_or_create_by(description: param, security_control: the_sc)
					end
				counter = counter + 1
				end
			end 
		end
	end	
	
	def create_statement(theSentance, the_sc)
		
		theSentance = theSentance.gsub "Statement: <br> ", "" 
		sentances = theSentance.split("<br>")
		the_statement = nil
		statement_id = the_sc.control_id + "_smt"
		if (sentances.count > 1)
			statement_id = the_sc.control_id + "_smt"
			first_sentance = sentances.first
			if first_sentance.starts_with? (/[a-z]. /)  
				description = "The organization:"
				the_statement = Statement.find_or_create_by(security_control: the_sc, description: description)	
				
				sentances.each do |thisSentance|
					pattern = /(\d{1,2}.)/
					items = thisSentance.gsub(pattern) {"<br>1" + $1}
					
					pattern = /(\([a-z]{1,2}\))/
					items  = items.gsub(pattern) {"<br>2" + $1}
					
					items = items.split("<br>")
					create_statement_items(items, the_statement.id, nil, 0, the_sc)	
				end
				
			else
				sentances.each do |the_sentance|
					description = the_sentance
					description = description.strip
					
					
					pattern = /([a-z]|[0-9])(\. .+)/
					
					if (description.starts_with? (pattern))
						statement_id = the_sentance.gsub(pattern) {statement_id +"_#{$1}"}
						%> statement_id should be <%= statement_id %> <br> <%
					else
					
						%> Pattern not found in <%= the_sentance %> - statement_id should be <%= statement_id %> <br> <%
					end   
					
					if (description != nil ) && (description != "")
						the_statement = Statement.find_or_create_by(security_control: the_sc, description: description, statement_id: statement_id)
					end	
				end
			end
			
		else
			%><br><br> NO items !!!<br><%
			description = theSentance
			the_statement = Statement.find_or_create_by(security_control: the_sc, description: description, statement_id: statement_id)
		end
			checkParam(description, the_sc)
		
	end
	
	def create_enhancement(enhancement, the_sc)
	
		pattern = / \((\d+)\) /m
		enhancement = enhancement.gsub(pattern) {"SubControl (" + $1 + ")"}
		pattern = /\<br\> \((\d+)\) /m
		enhancement = enhancement.gsub(pattern) {"SubControl (" + $1 + ")"}
		 
		#enhancement = enhancement.gsub "<br> (1) ", "SubControl (1)"
		#enhancement = enhancement.gsub "<br> (2) ", "SubControl (2)"
		#enhancement = enhancement.gsub "<br> (3) ", "SubControl (3)"
		#enhancement = enhancement.gsub "<br> (4) ", "SubControl (4)"
		#enhancement = enhancement.gsub "<br> (5) ", "SubControl (5)"
		#enhancement = enhancement.gsub "<br> (6) ", "SubControl (6)"
		#enhancement = enhancement.gsub "<br> (7) ", "SubControl (7)"
		
		the_controls = enhancement.split ("SubControl")
		the_statement = nil
		the_control= nil
		the_guidance = nil
		
		the_controls.each do |tempSentance|
			tempSentance = tempSentance.gsub ")[Status:", ") <br> <br> [Status:"
			%> tempSentance <%= tempSentance.inspect %> <br><br> <%
			status = "Active"
			enhancement_guidance  = nil
			theElements = tempSentance.split ("<br> Enhancement")
			theElements.each do |thisSentance|
			
				
				if (thisSentance.starts_with? (" ("))  && !(thisSentance.starts_with? ("Control Enhancements:"))
				 	controlID= nil
					statement = nil
					param =  nil
					pattern = /(\(\d+\))(.*)/
					fullcontrolID = thisSentance.gsub (pattern) {$1}
					newcontrolID = fullcontrolID.gsub ("("), ""
					controlnumber = newcontrolID.gsub (")"), ""
					newcontrolID = "#{the_sc.control_id}.#{controlnumber}"
					control_id = newcontrolID.gsub " ", ""
					tmpcontrol = nil
					
					if (@policy4 != nil)
						tmpcontrol = SecurityControl.where(security_policy: @policy4, control_id: control_id).first
						if (tmpcontrol != nil) 
							title = tmpcontrol.title
							name = tmpcontrol.name
						else
							name = "#{the_sc.control_id}#{fullcontrolID}"	
							title = "#{the_sc.title} (enhancement # #{controlnumber})"		
						end
					end
					
					the_policy = the_sc.security_policy
					
					security_control_family = the_sc.security_control_family
					control_class =  "SP800-53-enhancement"
					
					tmp_Status = thisSentance.split("[Status: Withdrawn: ")	
							if (tmp_Status[1] != nil)
					 	theSentance = tmp_Status[1]
						theSentance = theSentance.gsub ".]",""
						theSentance = theSentance.gsub ")[Status:", ") <br> <br> [Status:"
						
						#[Withdrawn: Incorporated into AC-2k.]
						active = false
						related_control = theSentance.gsub "Incorporated into ",""
						status = "Withdrawn" 
						set_control = true
						
					else
						status = "Active"
						pattern = /(\(\d+\))(.*)(\[Param: .*\]\.)/
						statement = thisSentance.gsub (pattern) {$2}
					
					end	
			
					
					if !(thisSentance.starts_with?("Related control"))
						name = name.gsub "PE-7(1)","PE-7 (1)"
						name = name.gsub "PE-7(2)","PE-7 (2)"
						pattern = /([A-Z][A-z]-\d+)(\(\d+\))/
						name = name.gsub(pattern) {$1 +" "+$2}
						the_control = SecurityControl.find_or_create_by(control_id: control_id,parent: the_sc, control_class: control_class, name: name,  title: title, security_policy:  the_policy, security_control_family: security_control_family, status: status)
						
						if (status == "Withdrawn")
							create_related_control(the_control, related_control, the_policy, "incorporated-into", "securitycontrol")
						end
						
						checkParam(thisSentance, the_control)
						if (statement!= nil) 
							pattern = /(\(([0-9])\)) (.*)/
							the_statement = statement.gsub (pattern) {$3}
							the_statement = the_statement .gsub "(a) ", "<br>(i) "
							the_statement = the_statement .gsub "(b) ", "<br>(ii) "
							the_statement = the_statement .gsub "(c) ", "<br>(iii) "
							the_statement = the_statement .gsub "(d) ", "<br>(iv) "
							the_statement = the_statement .gsub "(e) ", "<br>(v) "
							the_statement = the_statement .gsub "(f) ", "<br>(vi) "
							the_statement = the_statement .gsub "(g) ", "<br>(vii) "
							create_statement(the_statement, the_control)
						end
					end
				else
				%> Trying to setup guidance <br><br><%
					enhancement_guidance = thisSentance
					if (enhancement_guidance != nil) 
						description = enhancement_guidance.gsub "Enhancement Guidance: ", ""
						the_guidance = Guidance.find_or_create_by(security_control: the_control, description: description)
						
					end
					if ((thisSentance.starts_with? "Related controls:") || (thisSentance.starts_with? "Related control:"))
						thisSentance =  thisSentance.gsub "Related control: ", ""
						thisSentance =  thisSentance.gsub "Related controls: ", ""
						thisSentance =  thisSentance.gsub ";", ","
						create_related(thisSentance, the_control, the_policy, the_guidance)
					end
				end
			end
			
			
		end
		
		
	end
	def create_elements(the_control, the_policy, the_sc, the_scf, version)
		%>Creating elements - <%= the_control.count%><br><br><%
		the_control.each do |theSentance|
			%> <br> theSentance <%= theSentance.inspect %> <br><br> <% 
		end
		control_class = "SP800-53"
		settingStatementItmes = false
		
		related_set = false
		description  = ""
		the_guidance = nil
		
		the_control.each do |theSentance|
			
			%> theSentance =<%= theSentance%> <br> <%
			if (theSentance.starts_with? ("Statement:"))
				%> Creating Statement <br><%
				
				
			elsif ((theSentance.starts_with?("Related controls:")) || (theSentance.starts_with?("Related control:"))) && (related_set == false) 
				related = theSentance.gsub "Related controls:",""
				related = theSentance.gsub "Related control:",""
				create_related(related, the_sc, the_policy, the_guidance)
				
			else
				%> Unknown:<%= theSentance %> <br><%
			end
		end
	end
	
	
	
	def create_control(the_control, the_policy, parent_sc, the_scf, version)
		references = the_control.split(" References: ")[1]
		tmp_status = the_control.split("<br><br>")[2]
		
		%> the_control - <%= the_control %> - <%= tmp_status  %> <br><br><br><%
		
		
		control_split = the_control.split("Control Enhancements:")
		the_control = control_split.first
		enhancements = nil
		if ( control_split[1] != nil) 
			enhancements = control_split[1]
		end
		security_control_title = nil 
		
		params = nil
		related = nil  
		control_status = "Active"
		active = true
		parent = parent_sc
		control_class = "SP800-53"
		set_control = false
		related_control = ""
		controlCreated  = false
		settingStatementItmes = false
		the_sc = nil
		parentStatementID = nil
		parentItem = nil
		parentItemLetter = nil
		statements = nil
		guidance = nil
		relatedcontrols = nil
		
		 
		%> the_control- <%= the_control%> <br><Br><% 
		the_control = the_control.gsub "AUDIT RECORD <br><br>REVIEW, ANALYSIS, AND REPORTING", "AUDIT RECORD REVIEW, ANALYSIS, AND REPORTING <br><br> "
		
		puts ""
		puts "the_control #{the_control.inspect}"
		puts ""
		tmp_control = the_control.split("<br><br> Statement: ").first
		statements = the_control.split("<br><br> Statement: ")[1]
		
		if (statements != nil)
			statements = statements.split("<br><br>").first
		end 
		
		guidance = the_control.split("<br><br> Guidance: ")[1]
		if (guidance != nil)
			guidance = guidance.split("<br><br>").first
		end 
		
		
		if (enhancements != nil) && (enhancements.starts_with?("None"))
			enhancements = "None"
		end
		
		
		if (references!= nil)
			references= references.split("<br><br>").first
		end
		
		
		if (tmp_control.starts_with?("Control-ID:")) || (tmp_control.starts_with?(" Control-ID:"))
				
			tmp_control = tmp_control.gsub "Control-ID: ", ""
			tmp_control = tmp_control.split("<br><br>")
			control_id = tmp_control[0]
			if (tmp_control[1].starts_with?(" Control-Title: "))
				security_control_title = tmp_control[1].gsub " Control-Title: ", ""
				security_control_title.strip!
				security_control_title = security_control_title.titleize
				set_control = true
			end
		end
		
		%> The control =<%= control_id.inspect %> <br><br><%
		%> security_control_title =<%= security_control_title.inspect %> <br><br><%
		%> statements: <%= statements %> <br><br> <%
		%> guidance: <%= guidance %> <br><br> <%
		%> enhancements: <%= enhancements %> <br><br> <%
		%> references: <%= references %> <br><br> <%
		if (tmp_status != nil) && (tmp_status.starts_with? "[Status")
			%> I am withdrawn! -<%= tmp_status %> <Br><br><%
			
			
			
			theSentance = tmp_status.gsub /^\s/m,""
			theSentance = theSentance.gsub ")[Status:", ") <br> <br> [Status:"
			if (theSentance.include?("Status:"))
				%> Status - <%= theSentance %> <br> <%
				active = false
				pattern = /(^.* Incorporated into )([A-Z][A-z]-\d+.+)/
				related_control = theSentance.gsub(pattern) {$2}
				control_status = "Withdrawn" 
				set_control = true
				puts "theSentance - #{theSentance}"

			end
		end	
		
		
		if (set_control) && (control_id != nil) && (security_control_title != nil) 
			
			control_id = control_id.strip!
			the_sc = SecurityControl.find_or_create_by(control_id: control_id,parent: parent,control_class: control_class, name: control_id,  title: security_control_title, security_policy:  the_policy, security_control_family: the_scf, status: control_status)
			
			if (control_status == "Withdrawn")
				#create_related_control(the_sc, related_control, the_policy, "incorporated-into", "securitycontrol")
			end

			%> Created Security Control - <%= the_sc.inspect %> <br><%
			controlCreated = true
			
			if (control_status == "Active")
				active = true
			else
				puts "control_status -#{control_status}"
				
				create_related_control(the_sc, related_control, the_policy, "incorporated-into", "securitycontrol")
			end
			
		end
		
		#set the rest of the things
			
		if (controlCreated) && (the_sc != nil) && (active)
			#create_elements(sentances, the_policy, the_sc, the_scf, version)
			parentStatementID = nil
			
			if (statements != nil) 
				parentStatementID = create_statement(statements, the_sc)
						
			end
			
			if (guidance != nil) 
			 	parentStatementID = nil
				guidance = guidance.gsub "Guidance:",""
				
				relatedcontrols = guidance.split("Related Controls: ")[1]
				guidance = guidance.split("Related Controls: ")[0]
				description = guidance.gsub ":",""
				
				the_guidance = Guidance.find_or_create_by(security_control: the_sc, description: description)
				parentStatementID = nil
				settingStatementItmes = false
				
				
				relatedcontrols = relatedcontrols .gsub ".","" 
				if (relatedcontrols != nil)
					create_related(relatedcontrols, the_sc, the_policy, the_guidance)
					relatedcontrols = true
				end
			end
			
			
			if (enhancements != nil) && (enhancements != "None") 
				create_enhancement(enhancements, the_sc)		
			end
			
			if (references != nil) 
				create_relatedrefs(references, the_sc, nil)		
			end
			
		end
	end
	
	data = ""
	data = IO.binread(path)
	data = data.encode(Encoding.find('UTF-8'), {invalid: :replace, undef: :replace, replace: ''})
	single_line_data = data.squish
	
	fix_statements = single_line_data.gsub 'Control:', " Statement:"
	pattern = /(\d.\d{1,2}) (([A-Z]+(,)* )+)(Quick link to )(([A-Z][a-z]+)(,)* (and )*)+(summary table)/
	set_control_families = fix_statements.gsub(pattern) {" Family: Security_Family: " + $2 + "Class: <br><br>" }
	pattern = /([A-Z]{2}-\d{1,2}) (([A-Z]+\s)+)/
	set_controls_fields= set_control_families.gsub(pattern) {" <br><br> the_Control: Control-ID: "+ $1 + "<br><br> Control-Title: " + $2 + "<br><br>"}
	
	
	replacedGuidance = set_controls_fields.gsub 'Discussion:', " <br><br> Guidance:"
	replacedAssignment = replacedGuidance.gsub 'Assignment:', "Param:"
	replacedControlEnhancements = replacedAssignment.gsub " Control Enhancements: " , " <br><br> Control Enhancements: "
	
	replacedRelatedControls = replacedControlEnhancements.gsub 'Related controls:', " <br> Related controls:"
	replacedRelatedControls = replacedRelatedControls.gsub 'Related control:', " <br> Related control:"
	
	
	
	pattern = /(Related control[s:]+( [A-Z]{2}-\d{1,2}[.,])+)( \([0-9]+\))/
	replacedRelatedControls = replacedRelatedControls.gsub(pattern) {$1 + " <br> " + $3}
	pattern = /([A-Z] )(\[Withdrawn\:)/
	replacedStatus = replacedRelatedControls.gsub (pattern) {$1 + " <br> [Status: Withdrawn -"}
	replacedStatus = replacedRelatedControls.gsub "Withdrawn-", "Withdrawn - "
	replacedStatus = replacedRelatedControls.gsub "[Withdrawn", "[Status: Withdrawn"
	 
	replacedItems = replacedStatus.gsub(/([a-z]|;|.|:)( [a-z]\. )/) {$1 + " <br>" + $2}
	
	 
	replacedControlEnhancements = replacedItems.gsub " References: ", " <br><br> References: "
	
	replacedStatementItems = replacedControlEnhancements.gsub ' (i) ', " <br> (i) "
	replacedStatementItems2 = replacedStatementItems.gsub ' (ii) ', " <br> (ii) "
	replacedStatementItems3 = replacedStatementItems2.gsub ' (iii) ', " <br> (iii) "
	replacedStatementItems4 = replacedStatementItems3.gsub ' (iv) ', " <br> (iv) "
	replacedStatementItems5 = replacedStatementItems4.gsub ' (v) ', " <br> (v) "
	replacedStatementItems6 = replacedStatementItems5.gsub ' (vi) ', " <br> (vi) "
	replacedStatementItems7 = replacedStatementItems6.gsub ' (vii) ', " <br> (vii) "
	replacedStatementItems8 = replacedStatementItems7.gsub 'NIST Special Publications', "NIST Special Publication"
	pattern = /(APPENDIX )([A-Z]-[A-Z]+ )/
	replacedStatementItems8 = replacedStatementItems8.gsub(pattern) {""}
	
	pattern = /(PM-\d{1,2}) ([A-Z\s]+ )/
	replacedPMs = replacedStatementItems8.gsub (pattern) {"<br><br> the_Control: Control-ID: " + $1 + " <br><br> Control-Title: " + $2 }
	finallist2 = replacedPMs.gsub "the_Control: Control-ID: PM-1" , "<br><br> the_Control: Control-ID: PM-1"
	finallist3 = finallist2.gsub "Control Enhancements: (", "Control Enhancements: <br> ("
	finallist4 = finallist3.gsub ". (", ". <br> ("
	finallist5 = finallist4.gsub "PM-11 MISSION/BUSINESS PROCESS DEFINITION", "<br><br> the_Control: Control-ID: PM-11  <br><br> Control-Title: MISSION/BUSINESS PROCESS DEFINITION"
	pattern = /(Status: Withdrawn - Incorporated into [A-Z]{2}-\d{1,2}\].)( [A-Z]{2}-\d{1,2} )/
	finallist6 = finallist5.gsub(pattern) {$1 + "<br><br> the_Control: Control-ID: " + $2 + " <br><br> Control-Title: "}
	pattern = /([A-Z]{2}-\d{1,2} )([A-Z]{2}-\d{1,2} )([A-Z ]+ )/
	finallist7 = finallist6.gsub(pattern) {$1 + "<br><br> the_Control: Control-ID: " + $2 + " <br><br> Control-Title: " +$3  + " <br><br> "}
	
	pattern = /([A-Z]{2}-\d{1,2}. )([A-Z]{2}-\d{1,2} )([A-Z ]+ )/
	finallist8 = finallist7.gsub(pattern) {$1 + "<br><br> the_Control: Control-ID: " + $2 + " <br><br> Control-Title: " +$3 + " <br><br> "}
	finallist9 = finallist8.gsub "SC-21 SECURE NAME / ADDRESS RESOLUTION SERVICE (RECURSIVE OR CACHING RESOLVER)", "<br><br> the_Control: Control-ID: SC-21 <br><br> Control-Title: SECURE NAME / ADDRESS RESOLUTION SERVICE (RECURSIVE OR CACHING RESOLVER)" 
	finallist10 = finallist9.gsub "SI-5 SECURITY ALERTS, ADVISORIES, AND DIRECTIVES","<br><br> the_Control: Control-ID: SI-5 <br><br> Control-Title: SECURITY ALERTS, ADVISORIES, AND DIRECTIVES"
	finallist11 = finallist10.gsub "SI-6SI-7 SOFTWARE AND INFORMATION INTEGRITY","SI-6 <br><br> the_Control: Control-ID: SI-7 <br><br> Control-Title: SOFTWARE AND INFORMATION INTEGRITY"
	finallist12 = finallist11.gsub "Statement: //n Control-ID: AC-1 //n Control-Title:", " the_Control: Control-ID: AC-1:" 
	finallist13 = finallist12.gsub "AC-13", "<br><br> the_Control: Control-ID: AC-13 <br><br> Control-Title:"
	finallist13 = finallist13.gsub "AT-3 ROLE-BASED TRAINING", "<br><br> the_Control: Control-ID: AT-3 <br><br> Control-Title: ROLE-BASED TRAINING <br><br>"
	 
	finallist = finallist13.gsub "ACCESS CONTROL [Status: Withdrawn:", "ACCESS CONTROL <br><br> [Status: Withdrawn:"   
	
	finallist = finallist.gsub "AU-10 NON-REPUDIATION ",  "<br><br> the_Control: Control-ID: AU-10 <br><br> Control-Title: NON-REPUDIATION <br><br>"
 	finallist = finallist.gsub "AU-16 CROSS-ORGANIZATIONAL AUDIT LOGGING ", "<br><br> the_Control: Control-ID: AU-16 <br><br> Control-Title: CROSS-ORGANIZATIONAL AUDIT LOGGING <br><br>"
	finallist = finallist.gsub "CM-11 USER-INSTALLED SOFTWARE ", "<br><br> the_Control: Control-ID: CM-11 <br><br> Control-Title: USER-INSTALLED SOFTWARE <br><br>" 
	finallist = finallist.gsub "SI-14 NON-PERSISTENCE ", "<br><br> the_Control: Control-ID: SI-14 <br><br> Control-Title: NON-PERSISTENCE <br><br>"
	finallist = finallist.gsub "SI-17 FAIL-SAFE PROCEDURES ", "<br><br> the_Control: Control-ID: SI-17 <br><br> Control-Title: FAIL-SAFE PROCEDURES <br><br>" 
	finallist = finallist.gsub "SI-7 SOFTWARE, FIRMWARE, AND INFORMATION INTEGRITY", "<br><br> the_Control: Control-ID: SI-7 <br><br> Control-Title: SOFTWARE, FIRMWARE, AND INFORMATION INTEGRITY <br><br>"  
	finallist = finallist.gsub "SC-27 PLATFORM-INDEPENDENT APPLICATIONS", "<br><br> the_Control: Control-ID: SC-27 <br><br> Control-Title: PLATFORM-INDEPENDENT APPLICATIONS <br><br>"
	finallist = finallist.gsub "SC-34 NON-MODIFIABLE EXECUTABLE PROGRAMS", "<br><br> the_Control: Control-ID: SC-34 <br><br> Control-Title: NON-MODIFIABLE EXECUTABLE PROGRAMS <br><br>" 
	finallist = finallist.gsub "SC-37 OUT-OF-BAND CHANNELS", "<br><br> the_Control: Control-ID: SC-37 <br><br> Control-Title: OUT-OF-BAND CHANNELS <br><br>"
	
	objects = finallist.split(" Family: ")
	%> Data = <%= objects.count %> <br><br> <%
	objects.delete("")
	
	#Sets the fields for the security policy
	title = @doc.name
	the_policy = @doc.security_policy
	version = the_policy.version
	policy_name = the_policy.name
	
	
	objects.each do |the_object|
		
		title = the_object.split("Class:").first
		 
		title = title.gsub 'Security_Family:', ""
		title = title.gsub '<br>', ""
		
		if (title == nil )
			%> error <%		
		else
			title = title.strip
			
			family_class = nil
			
			%>title:<%= title %> <br><%
			

			if (title == "AUDIT AND ACCOUNTABILITY")
				the_scf = SecurityControlFamily.find_or_create_by(family: title ,  abv: "AU" ,   security_policy: the_policy, family_class: family_class)
			elsif (title == "ACCESS CONTROL")
				family_class = "TECHNICAL"
				the_scf = SecurityControlFamily.find_or_create_by(family: title,  abv: "AC" ,  security_policy:  the_policy, family_class: family_class)
			elsif (title == "AWARENESS AND TRAINING")
				the_scf = SecurityControlFamily.find_or_create_by(family: title,  abv: "AT" ,  security_policy:  the_policy, family_class: family_class)
			elsif (title == "CONFIGURATION MANAGEMENT")
				the_scf = SecurityControlFamily.find_or_create_by(family: title,  abv: "CM" ,  security_policy:  the_policy, family_class: family_class)
			elsif (title == "CONTINGENCY PLANNING")
				the_scf = SecurityControlFamily.find_or_create_by(family: title,  abv: "CP" ,  security_policy:  the_policy, family_class: family_class)
			elsif (title == "IDENTIFICATION AND AUTHENTICATION")
				the_scf = SecurityControlFamily.find_or_create_by(family: title,  abv: "IA" ,  security_policy:  the_policy, family_class: family_class)
			elsif (title == "INCIDENT RESPONSE")
				the_scf = SecurityControlFamily.find_or_create_by(family: title,  abv: "IR" ,  security_policy:  the_policy, family_class: family_class)
			elsif (title == "MAINTENANCE")
				the_scf = SecurityControlFamily.find_or_create_by(family: title,  abv: "MA" ,  security_policy:  the_policy, family_class: family_class)
			elsif (title == "MEDIA PROTECTION")
				the_scf = SecurityControlFamily.find_or_create_by(family: title,  abv: "MP" ,  security_policy:  the_policy, family_class: family_class)
			elsif (title == "PERSONNEL SECURITY")
				the_scf = SecurityControlFamily.find_or_create_by(family: title,  abv: "PS" ,  security_policy:  the_policy, family_class: family_class)
			elsif (title == "PHYSICAL AND ENVIRONMENTAL PROTECTION")
				the_scf = SecurityControlFamily.find_or_create_by(family: title,  abv: "PE" ,  security_policy:  the_policy, family_class: family_class)
			elsif (title == "PLANNING")
				the_scf = SecurityControlFamily.find_or_create_by(family: title,  abv: "PL" ,  security_policy:  the_policy, family_class: family_class)
			elsif (title == "PROGRAM MANAGEMENT")
				the_scf = SecurityControlFamily.find_or_create_by(family: title,  abv: "PM" ,  security_policy:  the_policy, family_class: family_class)
			elsif (title == "RISK ASSESSMENT")
				the_scf = SecurityControlFamily.find_or_create_by(family: title,  abv: "RA" ,  security_policy:  the_policy, family_class: family_class)
			elsif (title == "ASSESSMENT, AUTHORIZATION, AND MONITORING")
				the_scf = SecurityControlFamily.find_or_create_by(family: title ,  abv: "CA" ,  security_policy:  the_policy, family_class: family_class)
			elsif (title == "SYSTEM AND COMMUNICATIONS PROTECTION")
				the_scf = SecurityControlFamily.find_or_create_by(family: title ,  abv: "SC" ,  security_policy:  the_policy, family_class: family_class)
			elsif (title == "SYSTEM AND INFORMATION INTEGRITY")
				the_scf = SecurityControlFamily.find_or_create_by(family: title,  abv: "SI" ,  security_policy:  the_policy, family_class: family_class)
			elsif (title == "SYSTEM AND SERVICES ACQUISITION")
				the_scf = SecurityControlFamily.find_or_create_by(family: title ,  abv: "SA" ,  security_policy:  the_policy, family_class: family_class)
			elsif (title == "PROCESSING PERMISSIONS")
				the_scf = SecurityControlFamily.find_or_create_by(family: title ,  abv: "PP" ,  security_policy:  the_policy, family_class: family_class)
			elsif (title == "SUPPLY CHAIN RISK MANAGEMENT")
				the_scf = SecurityControlFamily.find_or_create_by(family: title ,  abv: "SR" ,  security_policy:  the_policy, family_class: family_class)
			else
				%> Error- Title not found, and possibly new.-<%= title %>-<Br><%
			end 
			
#Used during debug...			
erase_Controls = true

if (erase_Controls == true) && (the_scf != nil ) && (the_scf.security_controls != nil)
	the_scf.security_controls.destroy_all
elsif (the_scf == nil)
	%> Error- Title not found, and possibly new.-<%= title %>-<Br><%
end
			sec_controls  = 0
			sec_controls = the_object.split("the_Control:")
			control_count= sec_controls.count
			
			 #%> Creating Security Family - <%= title %> with <%=  control_count %> security Controls <br> <%
			if (title == "SYSTEM AND COMMUNICATIONS PROTECTION") || (true)
				sec_controls.each do |the_control|
				%> the_control - <% the_control %> <br><br> <%
					create_control(the_control, the_policy, nil, the_scf, version)
					 %><br> <br><%
				
				end
			end	
		end
		
	end

end

clean_up
%>